<!doctype html>
<!--[if lt IE 7 ]> <html lang="en" class="ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="ie9"> <![endif]-->
<!--[if !IE]><!--> <html lang="en"> <!--<![endif]-->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<script type="text/javascript" src="js/extras/jquery.min.1.7.js"></script>
<script type="text/javascript" src="js/extras/jquery-ui-1.8.20.custom.min.js"></script>
<script type="text/javascript" src="js/extras/jquery.ui.draggable.min.js"></script>
<script type="text/javascript" src="js/extras/jquery.ui.touch-punch.min.js"></script>
<script type="text/javascript" src="js/extras/jquery.mousewheel.min.js"></script>
<script type="text/javascript" src="js/extras/jgestures.min.js"></script>
<script type="text/javascript" src="js/extras/modernizr.2.5.3.min.js"></script>
<!-- <script type="text/javascript" src="js/lib/hash.js"></script> -->
<!--[if IE]><script type="text/javascript" src="js/excanvas.js"></script><![endif]-->

<style>
	body { margin: 0; padding: 0; }
	
	#bookDiv { position: absolute; left: 0; top: 0; right: 0; bottom: 0; z-index: 1; overflow: hidden; }
	#page { position: absolute; left: 0; top: 0; width: 100%; z-index: 10; }	
	#canvas { position: absolute; left: 0; top: 0; z-index: 100; }
	
	.bGroup { position: absolute; left: 0; top: 0; z-index: 999; }
	.btn {
		float: left;
		cursor: pointer;
		border: 1px solid #5252FF;		
		width: 32px;
		height: 32px;
		text-align: center;
		line-height: 32px;
		-webkit-border-radius: 16px;
		-moz-border-radius: 16px;
		border-radius: 16px;
		margin-right: 2px;		
	}	
	.btnArr {
		position: fixed;
		cursor: pointer;
		border: 0;		
		width: 32px;
		height: 32px;
		text-align: center;
		line-height: 32px;
		z-index: 999;
	}
	.bExt { display: none; }
	.bZoom.clk { background-color: #CAFF7A; }
	.bTool.clk { background-color: #CCE6FF; }
	.bZoom { color: #003870; background-color: #B1FF3D; background-repeat: no-repeat; background-position: center; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAA3NCSVQICAjb4U/gAAAACXBIWXMAAADdAAAA3QFwU6IHAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAHVQTFRF////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAANuvKZAAAACZ0Uk5TAAIFBggLFhobKzA9S05QYWp2f4CDh7Cyt7jExcbJy9Dd5ebw+v1b20x6AAABBElEQVQ4y62S0WKCMAxFM0SKClaRyVAEhXr+/xP3AEjbobzsvqX3tEmTiPSKkqxo2yJLIplTcDIMMlnw1982WGq2vn8wQJWnSqV5BZiDd99Ap8dId2CcN4IGLrGsj+eHiIjEF2jsOk7QxbK7A/1B3EE2+ZEBLbsn170as4CZfptAJes731/TpQqSV5BBLkeuli+5naOAVM7s7bpTKF5BC0oeKBtQ0LqAJwcoIPUBJ0UGuQ84RSZQ+YDzzb5RjtxGDa225LV6HNbk+8OaH/cm/Lwwqi3DTysX3sAhvKVVN/AIZ+03bc/+hDKvsBxeK/+DWC0RWhaIWhaI98BA6PeArHRd6+AXafgqvsE/FT0AAAAASUVORK5CYII41f3ddf9e98fb50824737ec401e7f2e0'); }		
	.bTool { color: #003870; background-color: #29B8FF; background-repeat: no-repeat; background-position: center; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAOcAAADnABlNk0xAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAANsSURBVFiFtddLbFVVFAbgLyCoiQktDwtUKI9Ci0aM1miMEMUHA02MDBACRKJOjHHmAHWgiTpwYIw6deAjYWZMDCZGJzIxURShIshDwQLVoMFqW1oNkOtgrxtujvvec1rsYKe3Z52z/v+s/f9rr6NWq5nKhVn4FH3ZeIUE0y4DvA17UMNZrJ4QAXTgW6yfJPjXuIhXMIQz6K1EIMAPYQRjuHcC4O34JsC3x7XbMYxBdLckgGtxEIfRifdwDndXAJ+NvQH+aCG2BqMYQFeWAObhexzFwoZqjMTDa1uAz8E+XMC2Qmxm/F0XFf0JncUEc3EAx9DZkLQ/hFQLInc2Ad8f4FsKsW6cwKr4f0fk2p2zzFc4hWVRzn0N4PU1jDsKxPsDfHOT6ryOX/BYVHIQPc18uwc/NwGvr79wG66I+87jkUy+a/BC3PdhPHsaK1qJsC1U3Ay8voZwK7ZjYyFHH6aHfo7gM0nIp5S5oMFKeyuQ+AO3FJ6dFluyM35vi3tPYtlEGlG71IjKSJzFTYVnOyWlf4Lx2NKl/8Go6Ov9FUj8jhvjjT/HA3giYiewJJu/YmcrWrHZ+g03YGvs999RhcVNc1ch0GC17yqQOINVQeIIFrXMWxH8OryFhVKXLCPxK3pE97ssAlgUZRwPa9XPiTISg8LrkyaALhwP8PUN1zvwQwUSp7F8UgSwJNQ7hvsz8fnSaVlG4mTOfi0JYKnk2zHcl4k/jFexIIRWRuJLzK9EQDqEBsJG9zRcvwovYiaul3z/cgjzWAmBx/F8KQEsl3r1OawrxNqlhvQRZuC5SP5UuOTHDPCAdEj1YldLAlgRohmVmXywWBpWDuKLSHzUpbmh7pZGAhtxpXQSvoSbswSwUrLNKO5qIrhhbMKTkfywmJgKJI/jXbyNrQ2xlXgtk1uPNCiMKIxb+Bib4veDsTXnpWE1L6pk3Q/wDGYVYrsUxnzYHW+0I5Nsg+SEDVJrvRBb0FHaYFiL9/GGNJI9hH8UXMWlY3OsUXjSGb4gyj4e4Acwrww8I+w38We86Ds5DXSFYkexJq7tjFI/HeD9mDsR8IyLno2cV+dc0B1CHJY+IqZLA2pNmvnmTBa8QGRGlkAEe6XjdEj6nLoojWWz/w/wLKEMw9XSiFWTvu3apwo8SyBI9Emf1G1TCV6r1fwLxnxqIp0rcv8AAAAASUVORK5CYIIb52c395bd5726a2c2abdd0c57e612184'); }		
	.bClear { color: #003870; background-color: #E0E0E0; background-repeat: no-repeat; background-position: center; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAA3NCSVQICAjb4U/gAAAACXBIWXMAAACOAAAAjgFr39bJAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAWVQTFRF////AAAAAAAAAAAAMwAAJAAAHBwAGhoaIBAQHA4OGw0NGg0NGAwMIBULHxQKHBMJGxIJGhIJIhERIBAQHw8PHg8PHQ8PIRQNHxMMHhIMIRALHxAKHRQPHBMOHhENHhENHRAMHBAMHxQMHhMLHRIPHRIOHBIOHxEOHxMNHhIMHhIMHRIMHREMHREOHhMOHxINHxINHxINHhEMHREMHREMHxMMHxMOHhIOHhIOHRIOHhENHhENHxIMHhIOHxEOHxENHhMNHhMNHRINHhIMHhEMHREMHxMOHhINHhINHRINHxINHhINHhENHhMNHhIOHhINHhINHhENHhMNHhINHhIOHhINHhINHhINHhINHhMOHhIOHRINHxINHhINHhINHhINHhINHhINHhINHhMNHhINHhINHhINHhINHhINHhINHhINHhINHhINHhINHhIMHhINHhMNHhINHhINHhINHhINHhINHhINCJ03twAAAHZ0Uk5TAAECBAUHCQoQEhMUFRgZGxwdHiAhIiMnKSovMTQ3Ozw+P0FDRkdISlFUVVdYWV5iY2RnaGprbG9wcXZ4fYGEhYiJi5GSk5aYmpyeoKKjqqussLK0u73DxMXOz9DR0tPU1tfY3N7f4+Tm6e7v8vP19vj5+vv9/mqvdrkAAAE2SURBVBgZpcGHNwJxAAfwrwauOoQrI1tGUmRnZlQ4e8sKUcq++/79xsPF0+95z+eD/wjuOSBiz9ENkVluQUS+1+shssA1iDgftFqIxLkCEdfzswsiKuMQqdEenBBZ5TxE6vQ7GSKbjEDEw5wNApWSfwSFtSZ5H0Zh4zpJXUEBVpXvIviVMpN5TPPNNn4w2xuHFg/0zKRsDpyTXIZBSqXTdyRvd+f8Vrwy+RKcgsFyeTHW5/O6TfjiYAh5+p+ayivdMgxtbEceyz5TalcxDNNZK5RoCJ+kZGJoYHi0AR/kXAxYJz34VLHDq8EqAI5uCYB6IwMxagoM/dnj4Ej0JNMJSBtaL4CSQD3yla3r5KFi75i4um4BSgHUmfCNM3xEnUwt2QDvqQnms2b8VN3jteFNkQKgGH/yApnFP0hF+CCUAAAAAElFTkSuQmCC6fb01dc86583aac0c8b381ad08800158'); }
	.bEraser { color: #003870; background-color: #E0E0E0; background-repeat: no-repeat; background-position: center; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAQAAADZc7J/AAAAxklEQVR4Ae3Qvy7DURjH4UdSnEoTcxEJt0HiBmy6mhCT23ETQpEQ/zqZjCZ/egEGV1BdLO/Q+CV6eubzOfPzzckrq1ptyb5EOR8YuZPK+ZVNw5go4gtYi4lCDjFRxAsm4nQb8Gein8uvDQytmmzejVtTW4zPtz35tDLBLz3rmNq6sRPQ9uhDN/hFHoeeH8cgefCuq+U8uPyJI5Dce9OfjUPPyCHo+A5u9okDLWfBlU28+LJrJ96WRnP+a8+pZRHGtr2q1Rr9ArTCOTSbwKWTAAAAAElFTkSuQmCC48d27f5a3722594e846bd3d5eaae4ffa'); }
	.bMarker { color: #003870; background-color: #2E8A5C; background-repeat: no-repeat; background-position: center; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAQAAADZc7J/AAABKElEQVR4Ae3Bz8vLcRwA8Jfs4fEc0NPTc/AgKzkQOTyn5eDHDkoOu+3gx0qRsnLm6rLLDlKWg9yURO1Ju7hpqT0lDaHEwVqjZs3aNwd8/A1vB6X2epn5bxScNu+v3fTDZ99dEIeyb/IoGaoI267lg/2gYGSbkDkdI0nmInbI5ITUvLbVPUny0CNrQoqmDtqs676+5JWdApb0XUFdR84RyW4ha5oomthnkxduCanqW7Ko5xLquuYFHJI5gQeaOGnqgIAt3qjhnC+WLRu4LKRh3Zw9xk7ZoOWxkJKJvTZ65jau6lkUsGLoPK57Z8FhmaNCqr5asWpq1YK3bgh6Lxn65BrueC4n6KOnfkkazhjLC+s465iB5KeyOE+0vfRbW14cjrurYpd/aeYPQ9xWIY5sw64AAAAASUVORK5CYIIabd521d23fc766a7f1dae898606f5619'); }
	.bCrayon { color: #003870; background-color: #2E8A5C; background-repeat: no-repeat; background-position: center; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAG7AAABuwBHnU4NQAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAIISURBVFiFxde7axVBFIDx3yiijdj4hDRaCBY2ahRExULtAin8B2ysRBDsUlv4iqLYCnYiEexSCGKlWEWJiYVBUEQ0gg+UgA8cizsX1nVnk3vvLhmYYncO833zOGfZEGO0nG1Fm5OHEIZCCPdCCGPZoBhjKx1DeIkfiDhfGdcy/BN240qSuNC6QAH+GXsK77sSl1oTKMC/YLhivCtxuXGBAjziVk1cV2K8MYHSyu/UXboUfzvFjDYN34eAGwlwsSL+AL7hBdY3Ci+NXS9fuhJ880BHUAcvxFzrnncVvG+BRVa+BYewOj1fTRK/yvC+BKrgWIXTeJtgEfM4hoP4XQXvWSADH8Zcgj7GCRzBK7yu2va+BDLw41jAT4xhZSH+bpKazcGXLJCBn8QfzGBXJtVmsal27j7hR9OlmsSafuGLCmTg29LzfBnQK7xWIJdqmEhnO5qBzywVnhWoge9P8JtNwCsFcvA0No6vWJuBb+wF/p+AThXLllc8wGQF/Hk/8CqBcymnc7X9PqaxVafCDQSvEniIRzUXcyTlfrfcDgT/R0Cnni+o+IaXJE41BS8L7E0Tf8TODLx75tPYMCi8LHCmsLXvsb1teFlgoiAQ8QY7cBhn24CXBd6VBMr9SdPwGKMQYxRCWJdyX4LNYSr1p5iKMX7QQgtp9UIIIzq/Us9ijN/bgNUKLFf7C6A0pQYwmJNKAAAAAElFTkSuQmCC9c5124cd657ad81a907941e0e45061df'); }
	.bPurple { color: #003870; background-color: #B8008A; }
	.bGreen { color: #003870; background-color: #8BD864; }
	.bYellow { color: #003870; background-color: #FFFF3D; }
	.bBrown { color: #003870; background-color: #A35200; }
	.bLeft{ left: 0; bottom: 0; background-repeat: no-repeat; background-position: center; background-image: url(images/arrL.png); }
	.bRight { right: 0; bottom: 0;  background-repeat: no-repeat; background-position: center; background-image: url(images/arrR.png); }
	.bZoom:hover { background-color: #CAFF7A; }
	.bTool:hover { background-color: #CCE6FF; }
	.bClear:hover { background-color: #FFFFFF; }
	.bEraser:hover { background-color: #FFFFFF; }
	.bMarker:hover { background-color: #3DB87A; }
	.bCrayon:hover { background-color: #3DB87A; }
	.bPurple:hover { background-color: #FF5CAD; }
	.bGreen:hover { background-color: #AFE495; }
	.bYellow:hover { background-color: #FFFF7A; }
	.bBrown:hover { background-color: #E07000; }
	.bLeft:hover { background-color: #E0E0E0; }
	.bRight:hover { background-color: #E0E0E0; }
</style>
</head>
<body>

<div id="bookDiv">
	<img id="page" src="pages/1.png">
	<canvas id="canvas"></canvas>	
</div>
<div class="bGroup">
	<!-- <div class="btn bLeft" title="上一頁">P</div> -->
	<!-- <div class="btn bRight" title="下一頁">N</div> -->
	<div class="btn bZoom" title="放大檢視"></div>
	<div class="btn bTool" title="撰寫附註"></div>
	<div class="btn bExt bClear" title="清除畫面"></div>
	<div class="btn bExt bEraser" title="橡皮擦"></div>	
	<div class="btn bExt bPurple" title="桃色筆刷"></div>
	<div class="btn bExt bGreen" title="綠色筆刷"></div>
	<div class="btn bExt bYellow" title="黃色筆刷"></div>
	<div class="btn bExt bBrown" title="棕色筆刷"></div>
</div>
<div class="btnArr bLeft" title="上一頁"></div>
<div class="btnArr bRight" title="下一頁"></div>

<script type="text/javascript">
window.allPages = 26;
window.zoom = 1;

function saveCanvas(){	
	var page = "page" + getPage();
	var data = $('#canvas')[0].toDataURL();
	if (typeof (localStorage) !== "undefined") {
		localStorage.setItem(page, data);
	}else{
		alert('Local Storage not supported.');
	}
	//console.log('saveCanvas = ' + page);
}
function loadCanvas(pg) {		
	var page = "page" + ((pg != null) ? pg : getPage());  
	var context = $('#canvas')[0].getContext('2d');
	/*
	var bgImage = new Image();
	bgImage.onload = function() {
		context.drawImage(this, 0, 0, window.nW, window.nH);
	};
	bgImage.src = './pages/' + pg + '.png';
	*/
	
	var data = localStorage.getItem(page);
	if(data != null){			
		var imageObj = new Image();
		imageObj.onload = function() {
			//context.drawImage(this, 0, 0);
			context.drawImage(this, 0, 0, window.dW * window.zoom, window.dH * window.zoom);
			//console.log('loadCanvas = ' + page);
		};
		imageObj.src = data;
	}
}
function prepareSize() {		
	var oW = 0;
	var oH = 0;
	var isFs = (window.fullScreen) || (window.innerWidth == screen.width && window.innerHeight == screen.height);
	if(isFs){
		oW = window.screen.width;
		oH = window.screen.height;
		//console.log('is fullscreen');
	}else{
		oW = window.innerWidth;
		oH = window.innerHeight;
	}
	window.nW = oW;
	window.nH = oH;
	window.dW = $('#page').width();
	window.dH = $('#page').height();
	
	$('#canvas').attr({'width':window.dW,'height':window.dH});
	
	canvasWidth = window.dW;
	canvasHeight = window.dH;
	drawingAreaX = 0;
	drawingAreaY = 35;
	drawingAreaWidth = window.dW;
	drawingAreaHeight = window.dH - 35;
	
}
function getPage(){
	var np = $('#page').attr('src');
	np = np.substring(6, np.length);
	np = np.substring(0, np.length - 4);
	return parseInt(np);
}
function goPage(dir){
	saveCanvas();
	resetCanvas();
	var np = getPage();
	if(dir > 0){
		var pg = (np < window.allPages) ? np + 1 : 0;
		$('#page').attr('src','pages/'+pg+'.png');		
		$('#page').removeClass().addClass('fadeInRight animated').one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function(){
			$(this).removeClass();
			loadCanvas(pg);
		});		
	}else{
		var pg = (np > 0) ? np - 1 : window.allPages;
		$('#page').attr('src','pages/'+pg+'.png');
		$('#page').removeClass().addClass('fadeInLeft animated').one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function(){
			$(this).removeClass();
			loadCanvas(pg);
		});
	}
}
function btnArrEvent(){			
	switch(true){
		case $(this).hasClass('bLeft'):
			goPage(0);					
		break;
		case $(this).hasClass('bRight'):
			goPage(1);
		break;
	}		
}		
function btnEvent(){			
	switch(true){		
		case $(this).hasClass('bZoom'):	
			saveCanvas();
			resetCanvas();
			if($(this).hasClass('clk')){
				$(this).removeClass('clk');	
				stopZoom();				
				startZoom(1);
			}else{	
				$(this).addClass('clk');						
				stopZoom();				
				startZoom(2);
			}
		break;		
		case $(this).hasClass('bTool'):
			if($(this).hasClass('clk')){
				$(this).removeClass('clk');
				$('.bExt').fadeOut();
				stopDraw();	
				saveCanvas();					
				startZoom(window.zoom);
			}else{	
				$(this).addClass('clk');						
				$('.bExt').fadeIn();
				startDraw();					
			}			
		break;
		case $(this).hasClass('bEraser'):
			curTool = "eraser";
		break;
		case $(this).hasClass('bClear'):
			resetCanvas();
		break;	
		case $(this).hasClass('bPurple'):
			curTool = "marker";
			curColor = colorPurple;
		break;	
		case $(this).hasClass('bGreen'):
			curTool = "marker";
			curColor = colorGreen;
		break;	
		case $(this).hasClass('bYellow'):
			curTool = "marker";
			curColor = colorYellow;
		break;	
		case $(this).hasClass('bBrown'):
			curTool = "marker";
			curColor = colorBrown;
		break;	
		/*
		case $(this).hasClass('bLeft'):
			goPage(0);					
		break;
		case $(this).hasClass('bRight'):
			goPage(1);
		break;
		case $(this).hasClass('bMarker'):
			curTool = "marker";
		break;	
		case $(this).hasClass('bCrayon'):
			curTool = "crayon";
		break;	
		case $(this).hasClass('bNote'):
			if($(this).hasClass('clk')){
				$(this).removeClass('clk');
				$('#noteDiv').hide();
				$('.bTool').fadeOut();
				$('.bExt').fadeOut();
				saveCanvas();				
			}else{	
				$(this).addClass('clk');						
				$('#noteDiv').show();
				$('.bTool').fadeIn();	
				loadCanvas();	
			}
		break;
		*/
	}		
}
function loadApp() {
	prepareSize();
	prepareCanvas();

	$('.btn').on('click swipeone', btnEvent);
	$('.btnArr').on('click swipeone', btnArrEvent);	
	
	startZoom(1);
	loadCanvas();	
}

yepnope({
	test: Modernizr.csstransforms,
	yep: ['css/jquery.ui.css'],
	nope: ['css/jquery.ui.html4.css'],
	both: ['js/drawing.js','css/animate.css'],
	complete: loadApp
});

</script>

</body>
</html>